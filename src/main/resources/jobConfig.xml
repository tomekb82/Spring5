<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:batch="http://www.springframework.org/schema/batch"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jdbc="http://www.springframework.org/schema/jdbc"
       xsi:schemaLocation="http://www.springframework.org/schema/batch
      http://www.springframework.org/schema/batch/spring-batch-2.2.xsd
      http://www.springframework.org/schema/beans
      http://www.springframework.org/schema/beans/spring-beans-4.2.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd">

  <batch:job id = "readAlbumsJob">
    <batch:step id = "step1">
      <batch:tasklet>
        <batch:chunk reader = "dbItemReader" writer = "xmlFileItemWriter"
                     processor = "itemProcessor" commit-interval = "10">
        </batch:chunk>
      </batch:tasklet>
    </batch:step>
  </batch:job>

  <bean id = "dbItemReader"
        class = "org.springframework.batch.item.database.JdbcCursorItemReader" scope = "step">
    <property name = "dataSource" ref = "mysqlDataSource" />
    <property name = "sql" value = "select * from album" />
    <property name = "rowMapper">
      <bean class = "pl.spring.batch.AlbumRowMapper" />
    </property>
  </bean>

  <bean id = "itemProcessor" class = "pl.spring.batch.AlbumItemProcessor" />

  <bean id = "xmlFileItemWriter"
        class = "org.springframework.batch.item.xml.StaxEventItemWriter">
   <!-- <property name = "resource" value = "file:target/albums.xml" />-->
    <!-- przy deploy na tomcat wyniki sa zapisywane w 'apache-tomcat\bin\target\albums.xml'-->
    <property name = "resource" value = "file:#{new java.io.File('.').getAbsolutePath()}/target/albums.xml" />
    <property name = "marshaller" ref = "reportMarshaller" />
    <property name = "rootTagName" value = "Albums" />
  </bean>

  <bean id = "reportMarshaller"
        class = "org.springframework.oxm.jaxb.Jaxb2Marshaller">
    <property name = "classesToBeBound">
      <list>
        <value>pl.spring.batch.AlbumDTO</value>
      </list>
    </property>
  </bean>

  <!-- connect to MySQL database -->
  <bean id = "mysqlDataSource"
        class = "org.springframework.jdbc.datasource.DriverManagerDataSource">
    <property name = "driverClassName" value = "com.mysql.jdbc.Driver" />
    <property name = "url" value = "jdbc:mysql://localhost:3306/springbatch" />
    <property name = "username" value = "root" />
    <property name = "password" value = "root" />
  </bean>

  <bean id = "transactionManager" class = "org.springframework.batch.support.transaction.ResourcelessTransactionManager" />

  <bean id = "jobRepository"
        class = "org.springframework.batch.core.repository.support.JobRepositoryFactoryBean">
    <property name = "dataSource" ref = "mysqlDataSource" />
    <property name = "transactionManager" ref="transactionManager" />
    <property name = "databaseType" value = "mysql" />
  </bean>

  <!-- create job-meta tables automatically -->
  <jdbc:initialize-database data-source = "mysqlDataSource">
    <jdbc:script location = "classpath:db/schema-drop-mysql.sql"/>
    <jdbc:script location = "classpath:db/schema-mysql.sql" />
  </jdbc:initialize-database>

  <bean id = "jobLauncher"
        class = "org.springframework.batch.core.launch.support.SimpleJobLauncher">
    <property name = "jobRepository" ref = "jobRepository" />
  </bean>

</beans>
